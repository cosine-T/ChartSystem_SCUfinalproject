# Chart System 软件需求（概述）

## 1 引言

Chart System 是一款运行于 Java SE 8+ 平台的桌面信号可视化工具，针对“教学实验”与“算法验证”两个典型场景而设计：教师可用它演示睡眠/生理信号的波形特征，学生可在同一界面上叠加算法处理结果、实时查看实验指标。系统只依赖本地文件系统，不涉及网络与数据库，因而在教室 PC、实验室工作站或个人笔记本上即可运行。本文档面向三类读者：

- **开发团队** —— 统一需求，支撑设计、实现、测试与维护；
- **课程教师** —— 用于验收学生项目输出；
- **后续维护者** —— 作为理解系统架构与扩展点的入口文档。

理论与实现依据主要包括四部分参考资料

| 序号 | 资料                                                         | 作用                                  |
| ---- | ------------------------------------------------------------ | ------------------------------------- |
| R-1  | Steve McConnell. *Code Complete*, 2nd Ed.                    | 文档写作、命名、模块划分指导          |
| R-2  | EDF+/BDF 文件格式规范 ([www.edfplus.info](http://www.edfplus.info/)) | `EDFReader` / `HeaderConfig` 实现依据 |
| R-3  | Java SE 8 API                                                | Swing UI 与 NIO File 处理             |
| R-4  | 现有源码树（见 *com.myapp.chart*、*com.biorecorder.edflib* 等包） | 功能基线与命名来源                    |

## 2 系统概述

| 维度         | 概要描述                                                     |
| ------------ | ------------------------------------------------------------ |
| **目标用户** | 教学人员、学生、算法研究者                                   |
| **运行环境** | Java SE 8+，Windows / macOS / Linux，单机运行，无外部服务依赖 |
| **总体架构** | 经典 **MVC**：• *Model* ⇒ `DataModel`/`ChannelData`• *View*  ⇒ `ChartFrame` + 若干 Swing 子面板• *Controller* ⇒ `ChartController` 及其四个子控制器 |
| **核心流程** | 读取文件 → 构造 `DataModel` → 渲染波形 → 用户交互（滚动/缩放/处理）→ 可选导出 |
| **运行模式** | ① **离线浏览**：打开文件即刻显示；② **实时监护**：`MonitorFrame` + `VitalSim` 持续注入模拟数据 |
| **外部接口** | • 文件系统（读/写）• 用户输入设备（鼠标、键盘）              |

整个应用采用经典 MVC 架构：`DataModel` 与 `ChannelData` 构成 *Model*，负责保存当前文件名、通道数据以及视窗位置；Swing 视图层由 `ChartFrame` 及其子面板承担，包含菜单栏、缩放条、通道面板、信息侧栏等；`ChartController` 则是中心 *Controller*，下辖文件、视图、通道、工具四个子控制器，把用户操作翻译成对模型的更新。

运行流程可归纳为三步：**读取 → 可视化 → 交互**。读取阶段支持两种输入——自定义二进制 float 文件和 EDF/BDF 医疗标准文件。二进制路径要求用户输入采样率与通道数，EDF/BDF 路径则自动解析头信息并校正通道配置。成功解析后，`FileController` 会把得到的 `DataModel` 交给主窗口初始化渲染。

可视化阶段使用 `ChannelRenderer` 在一个统一的时间基线上绘制折线。渲染时不仅要考虑数据量可能达到数百万，还要兼顾固定 60 px 左侧坐标轴、右侧滚动条与中央网格背景的刷新效率。实践中，通过对原始数组做抽样降频、对 Graphics2D 进行 clip 裁剪以及在实时模式下采用双缓冲扩容等手段来保证流畅性。

交互阶段提供横向滚动、对数缩放、纵向拉伸与自动居中的组合操作，并且所有动作都以事件方式回写到 `DataModel.currentOffset` 和 `windowLength` 两个字段。工具菜单进一步支持统计、信号处理、实时监护三大扩展功能：统计对话框能一次性给出多通道的最大/最小/均值/方差；处理对话框将“放大、微分、滑动均值、阈值标注”等算法封装成 `ProcessingOperation` 接口，用户设置参数后即刻把结果作为新通道叠加到图上；实时监护模式则用后台线程 `VitalSim` 生成 ECG、血压、血氧、呼吸四路模拟数据，并在 `MonitorFrame` 中滚动显示。

## 3 功能与逻辑

### 3.1  文件导入与数据模型

`BinaryReader` 负责自定义浮点流读取，它一次拉取 40 KiB 字节缓冲，按通道轮询填充到 `double[]` 数组，若文件过大则按“最多一百万样本/通道”自动抽样；`EDFReader` 基于第三方 `biorecorder.edflib`，读取时会动态计算单记录时长、信号采样率和抽样因子。两种 Reader 均把结果封装成 `DataModel`，其中每个 `ChannelData` 记录自身采样率、颜色、纵向缩放因子以及可选的高亮区段（用秒为单位存储，方便跨采样率高亮）。

### 3.2  渲染与交互

`ChannelRenderer` 在重绘时会根据当前 offset、windowLength 和通道采样率计算“全局采样索引 → 通道局部索引”的映射，从而保证多通道对齐。网格步长由 `AxisUtil.niceStep` 生成 1–2–5 序列，使得不论放到 8 小时还是一分钟窗口，刻度都保持整数级可读。纵向滚动条的取值被映射到 `scrollPos ∈ [-1,1]`，它与 `yScale` 一并决定真实的可视范围。

主缩放条用对数滑块实现，使得 10 %～1000 % 的宽度变化在人手可控范围内，“8 h / 1 h / 1 m”快捷键直接把 `windowLength` 置为对应秒数×采样率，随后调用 `centerYAll()` 让所有 Y 轴居中。实时模式下，为了避免主线程因 repaint 阻塞采样线程，UI 与 `VitalSim` 之间只通过一个线程安全的 `PlaybackController` 共享 offset 与窗口长度。

### 3.3  通道管理与工具

每个通道在控制面板上都有“可见、导出、关闭、移动、纵向缩放”五组控件，触发后立即更新模型并调用 `ChartFrame.reloadData()` 或 `refreshView()`。导出 TXT 逐行写 double，小端 BIN 写 float32；实时模式还允许指定“仅当前窗口”或“全部已录”两种导出范围。

统计功能使用 Java 8 Stream 直接在内存数组上做 min/max/avg/variance 四则操作，避免额外遍历；信号处理操作由 `OperationFactory` 动态创建实现类，每个实现类声明自身是否需要“参数”或“窗口大小”，对话框据此显示/隐藏对应控件，减少人为输入错误。

### 3.4  实时监护扩展

`MonitorFrame` 固定 250 Hz 全局采样率，所有模拟波形长度由 `PlaybackController` 控制自动扩容。心率采用简单峰值法（阈值+最小间隔）在最近 8 秒窗口内估算，血压取最近 1 秒最高/最低值，SpO₂ 与 RR 分别用移动平均与过零计数获得。所有指标每 2 秒刷新到右侧 `SimulationStatsPanel`。

播放/暂停按钮会切换 `playing` 标志；暂停时水平滚动条改为手动模式，不再自动跟随写入指针。时间缩放滑块实时调节 `windowLength` 并同步滚动条的 `visibleAmount`，保证缩放与拖动逻辑一致。

## 4 词汇及假设

| 术语                | 定义                                                         |
| ------------------- | ------------------------------------------------------------ |
| **Channel（通道）** | 有统一采样率与单位的一列序列数据                             |
| **SampleRate (Hz)** | 每秒采样次数；`ChannelData.sampleRate`                       |
| **WindowLength**    | 当前横向可视样本数                                           |
| **CurrentOffset**   | 当前窗口起始样本索引（0 基）                                 |
| **DataModel**       | 保存全局状态的业务对象                                       |
| **EDF/BDF**         | European Data Format / BioSemi Data Format，医学睡眠与生理信号标准文件 |
| **Highlight Range** | 需要以半透明颜色叠加显示的时间段                             |
| **MVC**             | Model-View-Controller 架构模式                               |

> **假设 & 约束**
>
> - 所有通道采样率相同，或已在 Reader 中重采样到全局时间轴；
> - 单机内存 ≥ 2 GB，可容纳 > 1 千万样本双缓冲；
> - Java SE 环境提供 `sun.nio.ch` 等通道优化，确保 NIO 读取效率。

## 5 产品质量目标

| 质量属性     | 可度量目标                                                   | 设计 / 代码依据                                              |
| ------------ | ------------------------------------------------------------ | ------------------------------------------------------------ |
| **性能**     | • 离线模式 < 500 ms 完成 8 h EDF 文件加载（SSD 环境）• 实时模式波形刷新周期 ≤ 40 ms（25 fps） | NIO 分块读取；`ChannelRenderer` 最小绘制；数据抽样；双缓冲   |
| **可靠性**   | • 文件解析异常均捕获并弹窗• 实时监护 ≥ 8 h 连续运行无内存泄漏 | `try-with-resources` 关闭流；`VitalSim.ensureCapacity()` 指数扩容 |
| **可用性**   | • UI 操作 ≤ 3 步完成“打开-缩放-导出”；• 所有控件提供 Tooltip | `ControlPanel`、`ZoomPanel` 明确提示                         |
| **可维护性** | • 模块内聚、接口单一；• 命名符合 R-1 建议，类名/方法名可自解释 | 见包 `controller` / `view` / `file` 分层                     |
| **可扩展性** | • 新增 Reader / Operation 不修改既有代码 > 5 行              | `FileReader`、`ProcessingOperation` 接口                     |
| **可移植性** | • 纯 Java SE，无第三方原生库；• Swing 兼容 Win/macOS/Linux   | `UIManager.setLookAndFeel()` 使用系统外观                    |
| **兼容性**   | • 向后兼容 EDF-16/24，向前预留 BDF 扩展位                    | `HeaderConfig.adjustLength()` 通用格式处理                   |
